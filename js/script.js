/** @format */

const ALL_FILIALS = {
	"1": {
		filialX: 312,
		filialY: 211,
		filialName: "Atabank",
		id: "1"
	},
	"3": {
		filialX: 309,
		filialY: 318,
		filialName: "Ağdam filialı",
		id: "3"
	},
	"5": {
		filialX: 98,
		filialY: 111,
		filialName: "Aqstafa filialı",
		id: "5"
	},
	"6": {
		filialX: 548,
		filialY: 600,
		filialName: "Astara filialı",
		id: "6"
	},
	"7": {
		filialX: 227,
		filialY: 31,
		filialName: "Balakən filialı",
		id: "7"
	},
	"8": {
		filialX: 328,
		filialY: 277,
		filialName: "Bərdə filialı",
		id: "8"
	},
	"9": {
		filialX: 495,
		filialY: 425,
		filialName: "Biləsuvar filialı",
		id: "9"
	},

	"11": {
		filialX: 502,
		filialY: 427,
		filialName: "Cəbrayıl filialı",
		id: "11"
	},
	"12": {
		filialX: 336,
		filialY: 278,
		filialName: "Bərdə kart mərkəzi",
		id: "12"
	},
	"14": {
		filialX: 496,
		filialY: 473,
		filialName: "Cəlilabad filialı",
		id: "14"
	},
	"15": {
		filialX: 212,
		filialY: 211,
		filialName: "Gəncə filialı",
		id: "15"
	},
	"18": {
		filialX: 252,
		filialY: 215,
		filialName: "Goranboy filialı",
		id: "18"
	},
	"19": {
		filialX: 211,
		filialY: 238,
		filialName: "Göygöl filialı",
		id: "19"
	},
	"20": {
		filialX: 567,
		filialY: 315,
		filialName: "Hacıqabul filialı",
		id: "20"
	},
	"22": {
		filialX: 442,
		filialY: 361,
		filialName: "İmişli filialı",
		id: "22"
	},
	"23": {
		filialX: 459,
		filialY: 191,
		filialName: "İsmayıllı filialı",
		id: "23"
	},
	"24": {
		filialX: 212,
		filialY: 221,
		filialName: "Kəpəz filialı",
		id: "24"
	},
	"25": {
		filialX: 489,
		filialY: 550,
		filialName: "Lerik filialı",
		id: "25"
	},
	"26": {
		filialX: 528,
		filialY: 505,
		filialName: "Masallı filialı",
		id: "26"
	},
	"27": {
		filialX: 532,
		filialY: 512,
		filialName: "Masallı kart mərkəzi",
		id: "27"
	},
	"31": {
		filialX: 362,
		filialY: 148,
		filialName: "Oğuz filialı",
		id: "31"
	},
	"34": {
		filialX: 295,
		filialY: 87,
		filialName: "Qax filialı",
		id: "34"
	},
	"35": {
		filialX: 75,
		filialY: 126,
		filialName: "Qazax filialı",
		id: "35"
	},
	"36": {
		filialX: 494,
		filialY: 114,
		filialName: "Quba filialı",
		id: "36"
	},
	"37": {
		filialX: 478,
		filialY: 79,
		filialName: "Qusar filialı",
		id: "37"
	},
	"38": {
		filialX: 490,
		filialY: 355,
		filialName: "Saatlı filialı",
		id: "38"
	},
	"39": {
		filialX: 515,
		filialY: 333,
		filialName: "Sabirabad filialı",
		id: "39"
	},
	"41": {
		filialX: 582,
		filialY: 390,
		filialName: "Salyan kart mərkəzi",
		id: "41"
	},
	"42": {
		filialX: 225,
		filialY: 177,
		filialName: "Samux filialı",
		id: "42"
	},
	"44": {
		filialX: 560,
		filialY: 116,
		filialName: "Şabran filialı",
		id: "44"
	},
	"45": {
		filialX: 519,
		filialY: 200,
		filialName: "Şamaxı filialı",
		id: "45"
	},
	"46": {
		filialX: 326,
		filialY: 130,
		filialName: "Şəki kart mərkəzi",
		id: "46"
	},
	"48": {
		filialX: 558,
		filialY: 342,
		filialName: "Şirvan filialı",
		id: "48"
	},
	"50": {
		filialX: 581,
		filialY: 149,
		filialName: "Siyəzən filialı",
		id: "50"
	},
	"51": {
		filialX: 656,
		filialY: 230,
		filialName: "Sumqayıt filialı",
		id: "51"
	},
	"52": {
		filialX: 654,
		filialY: 234,
		filialName: "Sumqayıt kart mərkəzi",
		id: "52"
	},
	"54": {
		filialX: 126,
		filialY: 154,
		filialName: "Tovuz filialı",
		id: "54"
	},
	"55": {
		filialX: 542,
		filialY: 77,
		filialName: "Xaçmaz filialı",
		id: "55"
	},
	"58": {
		filialX: 600,
		filialY: 202,
		filialName: "Xızı filialı",
		id: "58"
	},
	"59": {
		filialX: 465,
		filialY: 518,
		filialName: "Yardımlı filialı",
		id: "59"
	},
	"61": {
		filialX: 260,
		filialY: 58,
		filialName: "Zaqatala filialı",
		id: "61"
	},
	"62": {
		filialX: 550,
		filialY: 550,
		filialName: "Lənkəran filialı",
		id: "62"
	},
	"63": {
		filialX: 272,
		filialY: 254,
		filialName: "Naftalan filialı",
		id: "63"
	},
	"64": {
		filialX: 600,
		filialY: 444,
		filialName: "Neftçala filialı",
		id: "64"
	},
	"67": {
		filialX: 411,
		filialY: 160,
		filialName: "Qəbələ filialı",
		id: "67"
	},
	"68": {
		filialX: 170,
		filialY: 247,
		filialName: "Daşkəsən filialı",
		id: "68"
	},
	"69": {
		filialX: 320,
		filialY: 229,
		filialName: "Yevlax filialı",
		id: "69"
	},
	"70": {
		filialX: 360,
		filialY: 327,
		filialName: "Laçın filialı",
		id: "70"
	},
	"71": {
		filialX: 644,
		filialY: 228,
		filialName: "Qubadlı filialı",
		id: "71"
	},
	"73": {
		filialX: 410,
		filialY: 232,
		filialName: "Göyçay filialı",
		id: "73"
	},
	"75": {
		filialX: 183,
		filialY: 183,
		filialName: "Şəmkir filialı",
		id: "75"
	},
	"77": {
		filialX: 305,
		filialY: 205,
		filialName: "Mingəçevir filialı",
		id: "77"
	},
	"78": {
		filialX: 413,
		filialY: 302,
		filialName: "Zərdab filialı",
		id: "78"
	},
	"80": {
		filialX: 131,
		filialY: 245,
		filialName: "Gədəbəy filialı",
		id: "80"
	},
	"81": {
		filialX: 364,
		filialY: 407,
		filialName: "Füzuli filialı",
		id: "81"
	},
	"82": {
		filialX: 406,
		filialY: 262,
		filialName: "Ucar filialı",
		id: "82"
	},
	"83": {
		filialX: 391,
		filialY: 377,
		filialName: "Beyləqan filialı",
		id: "83"
	},
	"84": {
		filialX: 360,
		filialY: 230,
		filialName: "Ağdaş filialı",
		id: "84"
	},
	"85": {
		filialX: 456,
		filialY: 282,
		filialName: "Kürdəmir filialı",
		id: "85"
	},
	"86": {
		filialX: 485,
		filialY: 227,
		filialName: "Ağsu filialı",
		id: "86"
	},
	"88": {
		filialX: 349,
		filialY: 333,
		filialName: "Ağcəbədi filialı",
		id: "88"
	},
	"89": {
		filialX: 296,
		filialY: 278,
		filialName: "Tərtər filialı",
		id: "89"
	},
	"97": {
		filialX: 560,
		filialY: 229,
		filialName: "Qobustan filialı",
		id: "97"
	},
	"98": {
		filialX: 508,
		filialY: 108,
		filialName: "Şimal filialı",
		id: "98"
	},
	"102": {
		filialX: 206,
		filialY: 215,
		filialName: "Gəncə kart mərkəzi",
		id: "102"
	},
	"107": {
		filialX: 92,
		filialY: 478,
		filialName: "Babək filialı",
		id: "107"
	},
	"108": {
		filialX: 120,
		filialY: 503,
		filialName: "Culfa filialı",
		id: "108"
	},
	"109": {
		filialX: 32,
		filialY: 415,
		filialName: "Şərur filialı",
		id: "109"
	},
	"110": {
		filialX: 56,
		filialY: 442,
		filialName: "Kəngərli filialı",
		id: "110"
	},
	"111": {
		filialX: 13,
		filialY: 384,
		filialName: "Sədərək filialı",
		id: "111"
	},
	"112": {
		filialX: 112,
		filialY: 431,
		filialName: "Şahbuz filialı",
		id: "112"
	},
	"113": {
		filialX: 87,
		filialY: 466,
		filialName: "Naxçıvan filialı",
		id: "113"
	},
	"114": {
		filialX: 536,
		filialY: 505,
		filialName: "Cənub filialı",
		id: "114"
	},
	"115": {
		filialX: 167,
		filialY: 519,
		filialName: "Ordubad filialı",
		id: "115"
	}
};

const BAKU_FILIALS = {
	"1": {
		filialX: 313,
		filialY: 184,
		filialName: "28 May filialı",
		id: "1"
	},
	"2": {
		filialX: 186,
		filialY: 140,
		filialName: "Abşeron filialı",
		id: "2"
	},
	"4": {
		filialX: 413,
		filialY: 138,
		filialName: "Əhmədli filialı",
		id: "4"
	},
	"10": {
		filialX: 255,
		filialY: 150,
		filialName: "Binəqədi filialı",
		id: "10"
	},
	"13": {
		filialX: 277,
		filialY: 199,
		filialName: "Cəfər Cabbarlı filialı",
		id: "13"
	},
	"16": {
		filialX: 294,
		filialY: 157,
		filialName: "Gənclik filialı",
		id: "16"
	},
	"17": {
		filialX: 301,
		filialY: 166,
		filialName: "Gənclik Mall filialı",
		id: "17"
	},
	"21": {
		filialX: 263,
		filialY: 217,
		filialName: "İçərişəhər filialı",
		id: "21"
	},
	"28": {
		filialX: 294,
		filialY: 189,
		filialName: "Mərkəz filialı",
		id: "28"
	},
	"29": {
		filialX: 334,
		filialY: 153,
		filialName: "Nərimanov filialı",
		id: "29"
	},
	"30": {
		filialX: 397,
		filialY: 128,
		filialName: "Nizami filialı",
		id: "30"
	},
	"32": {
		filialX: 147,
		filialY: 257,
		filialName: "Qaradağ filialı",
		id: "32"
	},
	"33": {
		filialX: 356,
		filialY: 113,
		filialName: "Qara Qarayev filialı",
		id: "33"
	},
	"40": {
		filialX: 427,
		filialY: 98,
		filialName: "Sabunçu filialı",
		id: "40"
	},
	"43": {
		filialX: 298,
		filialY: 213,
		filialName: "Səbail filialı",
		id: "43"
	},
	"49": {
		filialX: 287,
		filialY: 133,
		filialName: "Şuşa filialı",
		id: "49"
	},
	"53": {
		filialX: 461,
		filialY: 116,
		filialName: "Suraxanı filialı",
		id: "53"
	},
	"56": {
		filialX: 344,
		filialY: 180,
		filialName: "Xətai filialı",
		id: "56"
	},
	"57": {
		filialX: 559,
		filialY: 81,
		filialName: "Xəzər filialı",
		id: "57"
	},
	"60": {
		filialX: 230,
		filialY: 195,
		filialName: "Yasamal filialı",
		id: "60"
	},
	"65": {
		filialX: 281,
		filialY: 176,
		filialName: "Nəsimi filialı",
		id: "65"
	},
	"74": {
		filialX: 415,
		filialY: 168,
		filialName: "Həzi Aslanov filialı",
		id: "74"
	},
	"79": {
		filialX: 428,
		filialY: 121,
		filialName: "Bakıxanov filialı",
		id: "79"
	},
	"87": {
		filialX: 409,
		filialY: 157,
		filialName: "Bravo 1 filialı",
		id: "87"
	},
	"91": {
		filialX: 314,
		filialY: 154,
		filialName: "Nərimanov kart mərkəzi filialı",
		id: "91"
	},
	"92": {
		filialX: 163,
		filialY: 282,
		filialName: "Lökbatan şöbəsi",
		id: "92"
	},
	"99": {
		filialX: 261,
		filialY: 166,
		filialName: "Bravo 2 filialı",
		id: "99"
	},
	"101": {
		filialX: 310,
		filialY: 215,
		filialName: "Sahil filialı",
		id: "101"
	},
	"103": {
		filialX: 380,
		filialY: 116,
		filialName: "Neftçilər kart mərkəzi filialı",
		id: "103"
	},
	"104": {
		filialX: 215,
		filialY: 231,
		filialName: "Badamdar filialı",
		id: "104"
	},
	"105": {
		filialX: 337,
		filialY: 117,
		filialName: "Bravo 3 filialı",
		id: "105"
	},
	"116": {
		filialX: 186,
		filialY: 260,
		filialName: "Ticarət filialı",
		id: "116"
	}
};

let regValue,
	inputLength,
	responseAllFilials = {},
	responseBakuFiliasl = {},
	bakuTimeColor = "#CBE0BA",
	bakuPercentColor = "#CBE0BA",
	averageWaitingTimeGlobal = 0;

String.prototype.toTime = function() {
	var sec_num = parseInt(this, 10); // don't forget the second param
	var hours = Math.floor(sec_num / 3600);
	var minutes = Math.floor((sec_num - hours * 3600) / 60);
	var seconds = sec_num - hours * 3600 - minutes * 60;

	if (hours < 10) {
		hours = "0" + hours;
	}
	if (minutes < 10) {
		minutes = "0" + minutes;
	}
	if (seconds < 10) {
		seconds = "0" + seconds;
	}
	return hours + ":" + minutes + ":" + seconds;
};

const INTERVAL = "5000"; // Bu refresh vaxtinin ms-nen olan reqemidi
const BASE_URL = "http://192.168.1.69:8080/QmaticMap/"; // buda ip
const GET_MAP_DATA = "getMapData";
const MAP_DATA_CUSTOM_WAIT = "getMapDataCusWait";
const GET_MAP_DATA_OPEN_POINT = "getMapDataOpenPoint";
const GET_MAP_MAX_WEIT_DATA = "getMapMaxWaitData";
const QMATIC_MAP_GET_MAP_AVE_WAIT_DATA = "getMapAveWaitData";
const QMATIC_MAP_QET_MAP_NO_SHOW_DATA = "getMapNoShowData";
const QMATIC_MAP_GET_MAP_REMOVED_DATA = "getMapRemovedData";
const QMATIC_MAP_GET_MAP_SERV_CUSTOM_DATA = "getMapServCusData";
const QMATIC_MAP_GET_MAP_AVE_SERV_TIME_DATA = "getMapAveServTimeData";
const QMATIC_MAP_GET_MAP_CLOSE_POINT_DATA = "getMapClosePointData";
const QMATIC_GET_TIMES = "getMapTimeData";
const QMATIC_GET_PERCENT = "getMapPercentData";
const QMATIC_VALYUTA = "getMapAveValyutaWaitData";
const GET_TOTAL_BY_PAGINATION = "getTotalBranchByPagination";

const getTotalBranches = async () => {
	const response = await fetch(BASE_URL + GET_TOTAL_BY_PAGINATION, {
		method: "POST",
		headers: {
			"Content-type": "application/json"
		},
		body: JSON.stringify({
			start: 1,
			count: 300,
			name: "%%"
		})
	});
	const data = await response.json();
	return data;
};

const getMapTimeData = async () => {
	const response = await fetch(BASE_URL + QMATIC_GET_TIMES);
	const data = await response.json();
	return data;
};

const getMapPercentData = async () => {
	const response = await fetch(BASE_URL + QMATIC_GET_PERCENT);
	const data = await response.json();
	return data;
};

const getMapData = async () => {
	const response = await fetch(BASE_URL + GET_MAP_DATA);
	let data = await response.json();
	return data;
};

/**
 * @card data
 */

const getMapAveValyutaWaitData = async () => {
	const response = await fetch(BASE_URL + QMATIC_VALYUTA);
	let data = await response.json();
	return data;
};

const getMapDataCusWait = async () => {
	const response = await fetch(BASE_URL + MAP_DATA_CUSTOM_WAIT);
	let data = await response.json();
	return data;
};

const getMapDataOpenPoint = async () => {
	const response = await fetch(BASE_URL + GET_MAP_DATA_OPEN_POINT);
	let data = await response.json();
	return data;
};

const getMapMaxWaitData = async () => {
	const response = await fetch(BASE_URL + GET_MAP_MAX_WEIT_DATA);
	let data = await response.json();
	return data;
};

const getMapAveWaitData = async () => {
	const response = await fetch(BASE_URL + QMATIC_MAP_GET_MAP_AVE_WAIT_DATA);
	let data = await response.json();
	return data;
};

const getMapNoShowData = async () => {
	const response = await fetch(BASE_URL + QMATIC_MAP_QET_MAP_NO_SHOW_DATA);
	let data = await response.json();
	return data;
};

const getMapRemovedData = async () => {
	const response = await fetch(BASE_URL + QMATIC_MAP_GET_MAP_REMOVED_DATA);
	let data = await response.json();
	return data;
};

const getMapServCusData = async () => {
	const response = await fetch(BASE_URL + QMATIC_MAP_GET_MAP_SERV_CUSTOM_DATA);
	let data = await response.json();
	return data;
};

const getMapAveServTimeData = async () => {
	const response = await fetch(
		BASE_URL + QMATIC_MAP_GET_MAP_AVE_SERV_TIME_DATA
	);
	let data = await response.json();
	return data;
};

const getMapClosePointData = async () => {
	const response = await fetch(BASE_URL + QMATIC_MAP_GET_MAP_CLOSE_POINT_DATA);
	let data = await response.json();
	return data;
};

//SVG start
var svgTime = document.getElementById("sgs-time"),
	svgPercent = document.getElementById("sgs-percent"),
	svgTimeBaku = document.getElementById("map-baki-time-svg");
svgPercentBaku = document.getElementById("map-baki-percent-svg");
NS = svgTime.getAttribute("xmlns");

const setCirclesTime = (key, value) => {
	// debugger;
	var circleTime = document.createElementNS(NS, "circle");
	circleTime.setAttribute("data-filialname", value.filialName);
	circleTime.setAttribute("id", "time-" + key);
	circleTime.setAttribute("data-id", key);
	circleTime.setAttribute("data-type", "time");
	circleTime.setAttributeNS(null, "cx", value.filialX);
	circleTime.setAttributeNS(null, "cy", value.filialY);
	circleTime.setAttributeNS(null, "r", 3);
	circleTime.classList.add("circle");
	if (value.averageWaitingTime !== undefined) {
		circleTime.setAttribute(
			"data-awg-text",
			String(value.averageWaitingTime).toTime()
		);
		let color = "green";
		if (value.averageWaitingTime > 600 && value.averageWaitingTime <= 900) {
			color = "yellow";
		} else if (
			value.averageWaitingTime > 900 &&
			value.averageWaitingTime <= 1200
		) {
			color = "orange";
		} else if (value.averageWaitingTime > 1200) {
			color = "red";
		}
		circleTime.style.stroke = color;
	}
	circleTime.style.stroke;
	svgTime.appendChild(circleTime);
};

const setCirclesPercent = (key, value) => {
	var circlePercent = document.createElementNS(NS, "circle");
	circlePercent.setAttribute("data-filialname", value.filialName);
	circlePercent.setAttribute("id", "percent-" + key);
	circlePercent.setAttribute("data-id", key);
	circlePercent.setAttribute("data-type", "percent");
	circlePercent.setAttributeNS(null, "cx", value.filialX);
	circlePercent.setAttributeNS(null, "cy", value.filialY);
	circlePercent.setAttributeNS(null, "r", 3);
	if (value.percent !== undefined) {
		circlePercent.setAttribute("data-percent-text", value.percent);
		let color = "green";
		if (value.percent > 10 && value.percent <= 15) {
			color = "yellow";
		} else if (value.percent > 15 && value.percent <= 20) {
			color = "orange";
		} else if (value.percent > 20) {
			color = "red";
		}
		circlePercent.style.stroke = color;
	}
	circlePercent.classList.add("circle");
	svgPercent.appendChild(circlePercent);
};

const setSirclesTimeBaku = (key, value) => {
	var circleTime = document.createElementNS(NS, "circle");
	circleTime.setAttribute("data-filialname", value.filialName);
	circleTime.setAttribute("id", "time-" + key);
	circleTime.setAttribute("data-id", key);
	circleTime.setAttribute("data-type", "time");
	circleTime.setAttributeNS(null, "cx", value.filialX);
	if (value.averageWaitingTime !== undefined) {
		console.log("averageWaitingTime -> value", value.averageWaitingTime);
		circleTime.setAttribute(
			"data-awg-text",
			String(value.averageWaitingTime).toTime()
		);
		averageWaitingTimeGlobal += value.averageWaitingTime;
		let color = "green";
		if (value.averageWaitingTime > 600 && value.averageWaitingTime <= 900) {
			color = "yellow";
		} else if (
			value.averageWaitingTime > 900 &&
			value.averageWaitingTime <= 1200
		) {
			color = "orange";
			if (bakuTimeColor !== "red") {
				bakuTimeColor = "orange";
			}
		} else if (value.averageWaitingTime > 1200) {
			color = "red";
			bakuTimeColor = "red";
		}
		circleTime.style.stroke = color;
	}
	circleTime.setAttributeNS(null, "cy", value.filialY);
	circleTime.setAttributeNS(null, "r", 3);
	circleTime.classList.add("circle");
	circleTime.style.stroke;
	svgTimeBaku.appendChild(circleTime);
};

const setSirclesPercentBaku = (key, value) => {
	var circlePercent = document.createElementNS(NS, "circle");
	circlePercent.setAttribute("data-filialname", value.filialName);
	circlePercent.setAttribute("id", "percent-" + key);
	circlePercent.setAttribute("data-id", key);
	circlePercent.setAttribute("data-type", "percent");
	circlePercent.setAttributeNS(null, "cx", value.filialX);
	circlePercent.setAttributeNS(null, "cy", value.filialY);
	circlePercent.setAttributeNS(null, "r", 3);
	if (value.percent !== undefined) {
		circlePercent.setAttribute("data-percent-text", value.percent);
		let color = "green";
		if (value.percent > 10 && value.percent <= 15) {
			color = "yellow";
		} else if (value.percent > 15 && value.percent <= 20) {
			color = "orange";
			if (bakuPercentColor !== "red") {
				bakuPercentColor = "orange";
			}
		} else if (value.percent > 20) {
			color = "red";
			bakuPercentColor = "red";
		}
		circlePercent.style.stroke = color;
	}
	circlePercent.classList.add("circle");
	svgPercentBaku.appendChild(circlePercent);
};

const drowBranchesTime = branches => {
	for (let [key, value] of Object.entries(branches)) {
		if (value.filialY !== undefined && value.filialX !== undefined) {
			if (inputLength > 2) {
				if (regValue.test(value.name)) {
					setCirclesTime(key, value);
				}
			} else {
				setCirclesTime(key, value);
			}
		}
	}
	document.getElementById("sgs-time").classList.remove("sgs-animation");
};

const drowBranchesTimeBaku = branches => {
	averageWaitingTimeGlobal = 0;

	for (let [key, value] of Object.entries(branches)) {
		if (value.filialY !== undefined && value.filialX !== undefined) {
			if (inputLength > 2) {
				if (regValue.test(value.name)) {
					setSirclesTimeBaku(key, value);
				}
			} else {
				setSirclesTimeBaku(key, value);
			}
		}
	}
	console.log(
		"averageWaitingTimeGlobal",
		String(averageWaitingTimeGlobal).toTime()
	);
	let averageWaitingTimeGlobalDisplay = String(
		averageWaitingTimeGlobal
	).toTime();
	svgTimeBaku.setAttribute("data-awg-text", averageWaitingTimeGlobalDisplay);
	document.getElementById("sgs-time").classList.remove("sgs-animation");
};

const drowBranchesPercent = branches => {
	for (let [key, value] of Object.entries(branches)) {
		if (value.filialY !== undefined && value.filialX !== undefined) {
			if (inputLength > 2) {
				if (regValue.test(value.name)) {
					setCirclesPercent(key, value);
				}
			} else {
				setCirclesPercent(key, value);
			}
		}
	}
	document.getElementById("sgs-percent").classList.remove("sgs-animation");
};

const drowBranchesPercentBaku = branches => {
	for (let [key, value] of Object.entries(branches)) {
		if (value.filialY !== undefined && value.filialX !== undefined) {
			if (inputLength > 2) {
				if (regValue.test(value.name)) {
					setSirclesPercentBaku(key, value);
				}
			} else {
				setSirclesPercentBaku(key, value);
			}
		}
	}
	document.getElementById("sgs-percent").classList.remove("sgs-animation");
};

const deleteBranches = () => {
	const CIRCLES = document.getElementsByClassName("circle");
	Object.values(CIRCLES).forEach(item => {
		item.parentNode.removeChild(item);
	});
};

const getAllData = () => {
	getMapAveValyutaWaitData().then(response => {
		$("#valyuta-custom")
			.parent()
			.show("slow");
		document.getElementById("valyuta-custom").innerHTML =
			response.averageValyutaWaiting;
	});
	getMapNoShowData().then(lo => {
		$("#no-show")
			.parent()
			.show("slow");
		$("#no-show").text(lo.noShow);
	});
	getMapAveServTimeData().then(resp => {
		$("#ave-serv-time")
			.parent()
			.show("slow");
		$("#ave-serv-time").text(resp.averageServingTime);
	});
	getMapAveWaitData().then(resp => {
		$("#ave-waiting-time")
			.parent()
			.show("slow");
		$("#ave-waiting-time").text(resp.averageWaitingTime);
	});
	getMapClosePointData().then(resp => {
		$("#closed-counters")
			.parent()
			.show("slow");
		$("#closed-counters").text(resp.closedServicePoints);
	});
	getMapDataCusWait().then(resp => {
		$("#waiting-custom")
			.parent()
			.show("slow");
		document.getElementById("waiting-custom").innerText = resp.customersWaiting;
	});
	getMapDataOpenPoint().then(resp => {
		$("#open-counters")
			.parent()
			.show("slow");
		$("#open-counters").text(resp.openServicePoints);
	});
	getMapMaxWaitData().then(resp => {
		$("#max-waiting-time")
			.parent()
			.show("slow");
		document.getElementById("max-waiting-time").innerText = resp.maxWaitingTime;
	});
	getMapServCusData().then(resp => {
		$("#served-custom")
			.parent()
			.show("slow");
		document.getElementById("served-custom").innerText = resp.servedCustomers;
	});
	getMapRemovedData().then(resp => {
		$("#removed")
			.parent()
			.show("slow");
		document.getElementById("removed").innerText = resp.removed;
	});
	getTotalBranches()
		.then(response => {
			const sum = response.reduce((accum, value) => {
				return accum + value.freeUsers;
			}, 0);
			document.getElementById("free-users").innerHTML = sum;
		})
		.catch(err => console.error(err));
	if (whichShown === "time") {
		getMapTimeData()
			.then(resp => {
				Object.keys(resp).forEach(item => {
					if (!!ALL_FILIALS[resp[item].id]) {
						responseAllFilials[resp[item].id] = {
							...resp[item],
							...ALL_FILIALS[resp[item].id]
						};
					}
					if (!!BAKU_FILIALS[resp[item].id]) {
						responseBakuFiliasl[resp[item].id] = {
							...resp[item],
							...BAKU_FILIALS[resp[item].id]
						};
					}
				});
			})
			.then(() => {
				deleteBranches();
				drowBranchesTime(responseAllFilials);
				bakuTimeColor = "#CBE0BA";
				drowBranchesTimeBaku(responseBakuFiliasl);
				document.getElementsByClassName(
					"baki-time"
				)[0].style.fill = bakuTimeColor;
				setTimeout(getAllData, INTERVAL);
			});
	} else {
		getMapPercentData()
			.then(resp => {
				Object.keys(resp).forEach(item => {
					if (!!ALL_FILIALS[resp[item].id]) {
						responseAllFilials[resp[item].id] = {
							...resp[item],
							...ALL_FILIALS[resp[item].id]
						};
					}
					if (!!BAKU_FILIALS[resp[item].id]) {
						responseBakuFiliasl[resp[item].id] = {
							...resp[item],
							...BAKU_FILIALS[resp[item].id]
						};
					}
				});
			})
			.then(() => {
				deleteBranches();
				drowBranchesPercent(responseAllFilials);
				bakuPercentColor = "#CBE0BA";
				drowBranchesPercentBaku(responseBakuFiliasl);
				document.getElementsByClassName(
					"baki-percent"
				)[0].style.fill = bakuPercentColor;
				setTimeout(getAllData, INTERVAL);
			});
	}
};

getAllData();

/***
 * cusotm search
 */

const inputElement = document.getElementById("search-td");
const searchList = document.getElementById("search-list");

getMapPercentData().then(response => {
	console.log("response", response);
	let newArr = [...new Set(response)];
	drowSearchsItems(response);
});

function setActionsForListItem() {
	const listForAction = document.getElementsByClassName("list-group-item");
	Object.keys(listForAction).forEach(item => {
		listForAction[item].onclick = function() {
			inputValue = this.getAttribute("data-name");
			var reg = new RegExp(inputValue, "i");
			regValue = reg;
			inputLength = inputValue.length;
			deleteBranches();
			if (whichShown === "time") {
				drowBranchesTime(responseAllFilials);
				drowBranchesTimeBaku(responseBakuFiliasl);
			} else {
				drowBranchesPercent(responseAllFilials);
				drowBranchesPercentBaku(responseBakuFiliasl);
			}
		};
	});
}

function drowSearchsItems(data) {
	let items = ``,
		counterItems = ``,
		departmentItems = ``;

	data.forEach(dataItem => {
		let item = ``,
			counterItem = ``,
			departmentItem = ``;
		item += `<div class="list-group-item" data-id="${dataItem.id}" data-name="${dataItem.name}">
					<span>${dataItem.name}</span>
				</div>`;
		counterItem += `<a class="dropdown-item counters-item" href="/counters/${dataItem.id}"  data-name="${dataItem.name}">${dataItem.name}</a>`;
		departmentItem += `<a class="dropdown-item  departments-item" href="/departments/${dataItem.id}"  data-name="${dataItem.name}">${dataItem.name}</a>`;
		items += item;
		counterItems += counterItem;
		departmentItems += departmentItem;
	});
	document.getElementById("search-list").innerHTML = items;
	document.getElementById("counter-list").innerHTML = counterItems;
	document.getElementById("department-list").innerHTML = departmentItems;
	setActionsForListItem();
}

function showNeedListItem(value, searchType) {
	searchList.style.transform = "scaleY(1)";
	let listItems;
	if (searchType == "counters") {
		listItems = document.getElementsByClassName("counters-item");
	} else if (searchType == "departments") {
		listItems = document.getElementsByClassName("departments-item");
	} else {
		listItems = document.getElementsByClassName("list-group-item");
	}

	var reg = new RegExp(value, "i");
	Object.keys(listItems).forEach(item => {
		let name = listItems[item].getAttribute("data-name");
		if (reg.test(name)) {
			listItems[item].style.display = "block";
		} else {
			listItems[item].style.display = "none";
		}
	});
	const listBool = Object.values(listItems).some(
		item => reg.test(item.getAttribute("data-name")) === true
	);
	if (searchType == "counters") {
		listBool
			? document
					.getElementById("counter-list")
					.appendChild("<span>No data find</span>")
			: null;
	} else if (searchType == "departments") {
		listBool
			? document
					.getElementById("department-list")
					.appendChild("<span>No data find</span>")
			: null;
	} else {
		listBool
			? document
					.getElementById("search-list")
					.appendChild("<span>No data find</span>")
			: null;
	}
}

/***
 * cusotm search
 */

document.onclick = function() {
	searchList.style.transform = "scaleY(0)";
};

const COUNTER_INPUT = document.getElementById("counter-input");
const DEPARTMENT_INPUT = document.getElementById("department-input");

$(function() {
	$("#search").on("input", function(e) {
		const VAL = this.value;
		showNeedListItem(VAL);
		if (VAL.length < 1) {
			searchList.style.transform = "scaleY(0)";
			var reg = new RegExp("", "i");
			regValue = reg;
			deleteBranches();
			if (whichShown === "time") {
				drowBranchesTime(responseAllFilials);
				drowBranchesTimeBaku(responseBakuFiliasl);
			} else {
				drowBranchesPercent(responseAllFilials);
				drowBranchesPercentBaku(responseBakuFiliasl);
			}
		}
	});

	COUNTER_INPUT.onfocusin = function() {
		$(this)
			.parent()
			.siblings("#counter-list")
			.show();
	};

	COUNTER_INPUT.onfocusout = function() {
		$(this)
			.parent()
			.siblings("#counter-list")
			.hide();
	};
	DEPARTMENT_INPUT.onfocusin = function() {
		console.log("$ -> this", this);
		$(this)
			.parent()
			.siblings("#department-list")
			.show();
	};

	DEPARTMENT_INPUT.onfocusout = function() {
		$(this)
			.parent()
			.siblings("#department-list")
			.hide();
	};

	$("#counter-input").on("input", function(e) {
		const VAL = this.value;
		showNeedListItem(VAL, "counters");
	});
	$("#department-input").on("input", function(e) {
		const VAL = this.value;
		showNeedListItem(VAL, "departments");
	});
});
